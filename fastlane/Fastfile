# Fastfile

default_platform(:ios)

platform :ios do

    # Before running a lane, make sure to install the app dependencies
    before_all do
        # install_pods
        # ensure_git_status_clean
    end

    lane :create_keys do
        match(type: "development", force_for_new_devices: true, git_basic_authorization: ENV["GIT_BASIC_AUTHORIZATION"])
        match(type: "adhoc", force_for_new_devices: true)
        match(type: "appstore")
    end

    desc "Download keys"
    lane :download_keys do
        match(type: "development", readonly: true, keychain_password: ENV["KEYCHAIN_PASSWORD"],app_identifier: "com.devopsmobile.HarnessReact",)
        match(type: "adhoc", readonly: true, keychain_password: ENV["KEYCHAIN_PASSWORD"],app_identifier: "com.devopsmobile.HarnessReact",)
        match(type: "appstore", readonly: true, keychain_password: ENV["KEYCHAIN_PASSWORD"],app_identifier: "com.devopsmobile.HarnessReact",)
    end

    desc 'Build the iOS application.'
    private_lane :build do
        download_keys
        increment_build_number(xcodeproj: './ios/HarnessReact.xcodeproj')
        ENV['IPHONEOS_DEPLOYMENT_TARGET'] = '13.4'
        gym(
            scheme: 'HarnessReact', 
            workspace: ENV["WORKSPACE"],
            clean: true,
            export_method: 'app-store',
            export_team_id: ENV["TEAM_ID"],
            # output_directory: "path/to/dir", # Destination directory. Defaults to current directory.
            output_name: "HarnessReact.ipa",       # specify the name of the .ipa file to generate (including file extension)
            # sdk: "iOS 13.4"
        )

    end



    desc "Build the iOS app and send to Test Flight"
    lane :beta do
        build
        # pilot
        commit_version_bump(
            message: 'Increment build number to [ci skip]', # Custom commit message
            xcodeproj: './ios/HarnessReact.xcodeproj', # Path to your Xcode project
            # You can specify more options here if needed
        )
        push_to_git_remote
        # api_key = app_store_connect_api_key(
        #     key_filepath: ENV["KEY_PATH"],
        #     duration: 1200,
        #     in_house: false
        # )
        # upload_to_testflight(
        #     beta_app_feedback_email: "diego.pereira@harness.io",
        #     beta_app_description: "Harness Mobile React Native IOS Demo",
        #     api_key: api_key,
        #     skip_waiting_for_build_processing: true,
        #     # apple_id: ENV["APP_STORE_CONNECT_APPLE_ID"],
        #     uses_non_exempt_encryption: false
        # )
    end

    lane :debug_lane do
        puts "Current Directory: #{Dir.pwd}"
        sh "ls -la"
    end


    desc "Deploy a new version to the App Store"
    lane :release do
        # Increment the build number
        increment_build_number

        # Build the app
        build

        # Push a new release to the App Store
        upload_to_app_store(
        skip_metadata: true, # Set to false if you want to upload metadata
        skip_screenshots: true, # Set to false if you want to upload screenshots
        force: true # Skip HTTPOK Error
        )
    end

    # Private lane to install CocoaPods dependencies
    private_lane :install_pods do
        
        # Dir.chdir("../ios") do
        #     puts "Changed to Directory: #{Dir.pwd}"
        #     if File.exist?("Podfile")
        #         puts "Found Podfile!"
        #     else
        #         puts "Podfile not found!"
        #     end
        # end
        puts "Debug:"
        puts "Changed to Directory: #{Dir.pwd}"
        fastlane_dir = %x(pwd)
        absolute_path = Pathname.new(File.expand_path(fastlane_dir)).parent
        puts "Fastlane Dir: #{absolute_path}"
        puts "Absolute Path: #{absolute_path}"
        ENV['IPHONEOS_DEPLOYMENT_TARGET'] = '13.4'
        cocoapods(
            repo_update: true,
            podfile: "#{absolute_path}/ios/Podfile"
        )
    end

end
